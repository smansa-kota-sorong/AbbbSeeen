<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABSENSI ONLINE - Kelas XII A2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Custom responsive breakpoints */
        @media (min-width: 480px) {
            .xs\:inline { display: inline; }
            .xs\:hidden { display: none; }
        }
        
        /* Mobile optimizations */
        @media (max-width: 640px) {
            .container { padding-left: 1rem; padding-right: 1rem; }
            .card-shadow { box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        }
        
        /* Tablet optimizations */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container { max-width: 100%; }
        }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .btn-hover:hover { transform: translateY(-2px); transition: all 0.3s ease; }
        .status-hadir { background: linear-gradient(135deg, #10b981, #059669); }
        .status-sakit { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .status-izin { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .status-alpa { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-bolos { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .animate-pulse-slow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Additional copy protection */
        * {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
        }
        
        /* Disable text selection on inputs when not focused */
        input:not(:focus), textarea:not(:focus), select:not(:focus) {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
        }
        
        /* Allow selection only when input is focused */
        input:focus, textarea:focus, select:focus {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        /* Enable dropdown functionality */
        select {
            -webkit-appearance: menulist !important;
            -moz-appearance: menulist !important;
            appearance: menulist !important;
            cursor: pointer !important;
        }
        
        select option {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" oncontextmenu="return false;" ondragstart="return false;" onselectstart="return false;">
    <!-- Header -->
    <div class="gradient-bg text-white py-4 sm:py-6 mb-6 sm:mb-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <div class="text-center sm:text-left">
                    <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold mb-2">üìö ABSENSI ONLINE</h1>
                    <p class="text-blue-100 text-sm sm:text-base">Kelas XII A2 - SMA NEGERI 1 KOTA SORONG</p>
                </div>
                <div class="text-center sm:text-right">
                    <p class="text-xs sm:text-sm opacity-90">Selamat datang,</p>
                    <p class="font-semibold text-sm sm:text-base">Di Kelas XII A2</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 max-w-7xl">
        <!-- Navigation -->
        <div class="flex justify-center mb-6 sm:mb-8 px-2">
            <div class="bg-white rounded-lg shadow-lg p-2 w-full max-w-4xl overflow-x-auto">
                <div class="flex space-x-1 sm:space-x-2 min-w-max sm:min-w-0 sm:justify-center">
                    <button onclick="showAbsensi()" id="btn-absensi" class="px-3 sm:px-6 py-2 sm:py-3 rounded-lg font-medium transition-all duration-300 bg-blue-500 text-white text-xs sm:text-sm whitespace-nowrap">
                        <i class="fas fa-clipboard-check mr-1 sm:mr-2"></i><span class="hidden xs:inline">Absensi</span><span class="xs:hidden">üìù</span>
                    </button>
                    <button onclick="showRekap()" id="btn-rekap" class="px-3 sm:px-6 py-2 sm:py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100 text-xs sm:text-sm whitespace-nowrap">
                        <i class="fas fa-chart-bar mr-1 sm:mr-2"></i><span class="hidden sm:inline">Rekap Harian</span><span class="sm:hidden">üìä</span>
                    </button>
                    <button onclick="showEditAbsen()" id="btn-edit" class="px-3 sm:px-6 py-2 sm:py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100 text-xs sm:text-sm whitespace-nowrap">
                        <i class="fas fa-chart-line mr-1 sm:mr-2"></i><span class="hidden sm:inline">Rekapan Semester</span><span class="sm:hidden">üìà</span>
                    </button>
                    <button onclick="showBimbelRecap()" id="btn-bimbel" class="px-3 sm:px-6 py-2 sm:py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100 text-xs sm:text-sm whitespace-nowrap">
                        <i class="fas fa-graduation-cap mr-1 sm:mr-2"></i><span class="hidden sm:inline">Rekapan Bimbel</span><span class="sm:hidden">üéì</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Absensi Section -->
        <div id="absensi-section">
            <!-- Date and Time Info -->
            <div class="bg-white rounded-xl card-shadow p-4 sm:p-6 mb-6 sm:mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                    <div class="flex items-center space-x-3 sm:space-x-4 w-full sm:w-auto">
                        <div class="bg-blue-100 p-2 sm:p-3 rounded-full">
                            <i class="fas fa-calendar-alt text-blue-600 text-lg sm:text-xl"></i>
                        </div>
                        <div class="flex-1 sm:flex-none">
                            <h3 class="font-semibold text-gray-800 text-sm sm:text-base">Tanggal Absensi</h3>
                            <p class="text-gray-600 text-xs sm:text-sm" id="current-date"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3 sm:space-x-4 w-full sm:w-auto">
                        <div class="bg-green-100 p-2 sm:p-3 rounded-full">
                            <i class="fas fa-clock text-green-600 text-lg sm:text-xl"></i>
                        </div>
                        <div class="flex-1 sm:flex-none">
                            <h3 class="font-semibold text-gray-800 text-sm sm:text-base">Waktu</h3>
                            <p class="text-gray-600 text-xs sm:text-sm" id="current-time"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-xl card-shadow p-4 sm:p-6 mb-6 sm:mb-8">
                <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4 sm:mb-6">Pengaturan Absensi</h3>
                
                <!-- Date and Time Selection -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-2 text-blue-500"></i>Pilih Tanggal
                        </label>
                        <input type="date" id="tanggal-absensi" class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-clock mr-2 text-green-500"></i>Pilih Jam Pelajaran
                        </label>
                        <select id="jam-ke" class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">-- Pilih Jam --</option>
                            <option value="1">Jam ke-1</option>
                            <option value="2">Jam ke-2</option>
                            <option value="3">Jam ke-3</option>
                            <option value="4">Jam ke-4</option>
                            <option value="5">Jam ke-5</option>
                            <option value="6">Jam ke-6</option>
                            <option value="7">Jam ke-7</option>
                            <option value="8">Jam ke-8</option>
                            <option value="9">Jam ke-9</option>
                            <option value="Bimbel">Bimbel</option>
                        </select>
                    </div>
                    
                    <div class="flex items-end sm:col-span-2 lg:col-span-1">
                        <button onclick="setAllStatus('Hadir')" class="btn-hover w-full px-4 sm:px-6 py-2 sm:py-3 bg-green-500 text-white rounded-lg font-medium shadow-lg text-sm sm:text-base">
                            <i class="fas fa-check-circle mr-2"></i>Hadir Semua
                        </button>
                    </div>
                </div>
            </div>

            <!-- Students List -->
            <div class="bg-white rounded-xl card-shadow p-4 sm:p-6 mb-6 sm:mb-8">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 sm:mb-6">Daftar Siswa</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4" id="students-container">
                    <!-- Students cards will be populated here -->
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center mb-6 sm:mb-8 px-4">
                <button onclick="submitAbsensi()" id="submit-btn" class="btn-hover w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-bold text-base sm:text-lg shadow-xl">
                    <i class="fas fa-paper-plane mr-2"></i>Kirim Absensi
                </button>
            </div>
        </div>

        <!-- Rekapan Semester Section -->
        <div id="edit-section" class="hidden">
            <!-- Current Date Display -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-8">
                <div class="text-center">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Rekapan Absensi Semester (Jam 1-9)</h3>
                    <p class="text-lg text-gray-600" id="semester-date"></p>
                    <p class="text-sm text-gray-500 mt-2">Kelas XII A2 - Total 36 Siswa</p>
                </div>
            </div>

            <!-- Attendance Summary Table -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Rekapan Kehadiran Siswa (Jam 1-9)</h3>
                    <button onclick="loadSemesterData()" id="load-semester-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Muat Data
                    </button>
                </div>
                
                <div id="loading-semester" class="text-center py-8 hidden">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Memuat data rekapan semester...</p>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full" id="semester-table">
                        <thead>
                            <tr class="border-b-2 border-gray-200 bg-gray-50">
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">No</th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">Nama Lengkap</th>
                                <th class="text-center py-4 px-3 font-semibold text-green-700">Hadir</th>
                                <th class="text-center py-4 px-3 font-semibold text-blue-700">Izin</th>
                                <th class="text-center py-4 px-3 font-semibold text-yellow-700">Sakit</th>
                                <th class="text-center py-4 px-3 font-semibold text-red-700">Alpa</th>
                                <th class="text-center py-4 px-3 font-semibold text-purple-700">Bolos</th>
                            </tr>
                        </thead>
                        <tbody id="semester-table-body">
                            <!-- Student rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bimbel Recap Section -->
        <div id="bimbel-section" class="hidden">
            <!-- Current Date Display -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-8">
                <div class="text-center">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Rekapan Absensi Bimbel</h3>
                    <p class="text-lg text-gray-600" id="bimbel-date"></p>
                    <p class="text-sm text-gray-500 mt-2">Kelas XII A2 - Total 36 Siswa</p>
                </div>
            </div>

            <!-- Attendance Summary Table -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Rekapan Kehadiran Bimbel</h3>
                    <button onclick="loadBimbelData()" id="load-bimbel-btn" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Muat Data Bimbel
                    </button>
                </div>
                
                <div id="loading-bimbel" class="text-center py-8 hidden">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Memuat data rekapan bimbel...</p>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full" id="bimbel-table">
                        <thead>
                            <tr class="border-b-2 border-gray-200 bg-purple-50">
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">No</th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">Nama Lengkap</th>
                                <th class="text-center py-4 px-3 font-semibold text-green-700">Hadir</th>
                                <th class="text-center py-4 px-3 font-semibold text-blue-700">Izin</th>
                                <th class="text-center py-4 px-3 font-semibold text-yellow-700">Sakit</th>
                                <th class="text-center py-4 px-3 font-semibold text-red-700">Alpa</th>
                                <th class="text-center py-4 px-3 font-semibold text-purple-700">Bolos</th>
                            </tr>
                        </thead>
                        <tbody id="bimbel-table-body">
                            <!-- Student rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Rekap Section -->
        <div id="rekap-section" class="hidden">
            <!-- Date and Period Filter -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Filter Rekap Absensi</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-2 text-blue-500"></i>Pilih Tanggal
                        </label>
                        <input type="date" id="rekap-tanggal" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-clock mr-2 text-green-500"></i>Pilih Jam Pelajaran
                        </label>
                        <select id="rekap-jam-ke" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">-- Semua Jam --</option>
                            <option value="1">Jam ke-1</option>
                            <option value="2">Jam ke-2</option>
                            <option value="3">Jam ke-3</option>
                            <option value="4">Jam ke-4</option>
                            <option value="5">Jam ke-5</option>
                            <option value="6">Jam ke-6</option>
                            <option value="7">Jam ke-7</option>
                            <option value="8">Jam ke-8</option>
                            <option value="9">Jam ke-9</option>
                            <option value="Bimbel">Bimbel</option>
                        </select>
                    </div>
                    
                    <div class="flex items-end">
                        <button onclick="filterRekapData()" class="btn-hover w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-medium shadow-lg">
                            <i class="fas fa-filter mr-2"></i>Filter Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Rekap Absensi</h3>
                    <div class="text-sm text-gray-600" id="rekap-info">
                        Menampilkan data hari ini
                    </div>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4 mb-6">
                    <div class="bg-green-50 p-3 sm:p-4 rounded-lg border border-green-200">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 text-lg sm:text-2xl mr-2 sm:mr-3"></i>
                            <div>
                                <p class="text-green-700 font-semibold text-xs sm:text-sm">Hadir</p>
                                <p class="text-lg sm:text-2xl font-bold text-green-800" id="count-hadir">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-yellow-50 p-3 sm:p-4 rounded-lg border border-yellow-200">
                        <div class="flex items-center">
                            <i class="fas fa-thermometer-half text-yellow-500 text-lg sm:text-2xl mr-2 sm:mr-3"></i>
                            <div>
                                <p class="text-yellow-700 font-semibold text-xs sm:text-sm">Sakit</p>
                                <p class="text-lg sm:text-2xl font-bold text-yellow-800" id="count-sakit">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-3 sm:p-4 rounded-lg border border-blue-200">
                        <div class="flex items-center">
                            <i class="fas fa-hand-paper text-blue-500 text-lg sm:text-2xl mr-2 sm:mr-3"></i>
                            <div>
                                <p class="text-blue-700 font-semibold text-xs sm:text-sm">Izin</p>
                                <p class="text-lg sm:text-2xl font-bold text-blue-800" id="count-izin">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-red-50 p-3 sm:p-4 rounded-lg border border-red-200">
                        <div class="flex items-center">
                            <i class="fas fa-times-circle text-red-500 text-lg sm:text-2xl mr-2 sm:mr-3"></i>
                            <div>
                                <p class="text-red-700 font-semibold text-xs sm:text-sm">Alpa</p>
                                <p class="text-lg sm:text-2xl font-bold text-red-800" id="count-alpa">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-purple-50 p-3 sm:p-4 rounded-lg border border-purple-200 col-span-2 sm:col-span-1">
                        <div class="flex items-center">
                            <i class="fas fa-user-slash text-purple-500 text-lg sm:text-2xl mr-2 sm:mr-3"></i>
                            <div>
                                <p class="text-purple-700 font-semibold text-xs sm:text-sm">Bolos</p>
                                <p class="text-lg sm:text-2xl font-bold text-purple-800" id="count-bolos">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Attendance Section -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Detail Kehadiran Siswa</h3>
                    <button onclick="loadDetailedAttendance()" id="load-detail-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-users mr-2"></i>Tampilkan Detail
                    </button>
                </div>
                
                <div id="loading-detailed" class="text-center py-8 hidden">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Memuat detail kehadiran siswa...</p>
                </div>

                <div id="detailed-attendance-content" class="hidden">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>

            <!-- History Section -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Riwayat Absensi</h3>
                    <button onclick="loadAttendanceHistory()" id="refresh-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                    </button>
                </div>
                
                <div id="loading-history" class="text-center py-8 hidden">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Memuat data riwayat absensi...</p>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full" id="history-table">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Tanggal</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Jam Ke</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Nama Siswa</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">JK</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">NISN</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Status</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Waktu Input</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-gray-500">
                                    Klik "Refresh Data" untuk memuat riwayat absensi
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center">
            <div class="mb-4">
                <i class="fas fa-check-circle text-green-500 text-6xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Absensi Berhasil Dikirim!</h3>
            <p class="text-gray-600 mb-6">Data absensi berhasil disimpan</p>
            <button onclick="closeModal()" class="px-6 py-3 bg-green-500 text-white rounded-lg font-medium">
                OK
            </button>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center">
            <div class="mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-6xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Gagal Mengirim Data</h3>
            <p class="text-gray-600 mb-6" id="error-message">Terjadi kesalahan saat mengirim data. Silakan coba lagi.</p>
            <button onclick="closeErrorModal()" class="px-6 py-3 bg-red-500 text-white rounded-lg font-medium">
                OK
            </button>
        </div>
    </div>

    <script>
        // Student data
        const students = [
            {no: 1, nama: "ALDRIAN RONALSON TITIHERU", jk: "Laki-Laki", agama: "Kristen", nisn: "0086569596", tanggalLahir: "2008-06-21"},
            {no: 2, nama: "Alfian Adi Purnomo", jk: "Laki-Laki", agama: "Islam", nisn: "0074600412", tanggalLahir: "2007-11-12"},
            {no: 3, nama: "Aprilia Elisabet Yesnat", jk: "Perempuan", agama: "Kristen", nisn: "0074869716", tanggalLahir: "2007-04-19"},
            {no: 4, nama: "Aurilius Tian Gerardo Saputra", jk: "Laki-Laki", agama: "Kristen", nisn: "0084182312", tanggalLahir: "2008-07-27"},
            {no: 5, nama: "Bryan Edward Julyanto Bukari", jk: "Laki-Laki", agama: "Kristen", nisn: "0085773109", tanggalLahir: "2008-07-14"},
            {no: 6, nama: "Cici Deswita Febriani", jk: "Perempuan", agama: "Islam", nisn: "0087909379", tanggalLahir: "2008-02-02"},
            {no: 7, nama: "CINTA LAURA HURULEA", jk: "Perempuan", agama: "Kristen", nisn: "0071572020", tanggalLahir: "2007-06-25"},
            {no: 8, nama: "DANIYATI", jk: "Perempuan", agama: "Islam", nisn: "0084706853", tanggalLahir: "2008-02-17"},
            {no: 9, nama: "Deby Debora Kemesrar", jk: "Perempuan", agama: "Kristen", nisn: "0077862282", tanggalLahir: "2007-12-07"},
            {no: 10, nama: "DELVERO EDWADT KALAMI", jk: "Laki-Laki", agama: "Kristen", nisn: "0074678081", tanggalLahir: "2007-03-19"},
            {no: 11, nama: "ELDA W. KAMESFLE", jk: "Perempuan", agama: "Kristen", nisn: "0086951699", tanggalLahir: "2008-09-16"},
            {no: 12, nama: "FALEN PRATAMA AYGE", jk: "Laki-Laki", agama: "Islam", nisn: "0082593218", tanggalLahir: "2008-01-08"},
            {no: 13, nama: "Falensia Marissa Runtu", jk: "Perempuan", agama: "Kristen", nisn: "0083861529", tanggalLahir: "2008-03-04"},
            {no: 14, nama: "HARRY PANCA POLSIARY", jk: "Laki-Laki", agama: "Kristen", nisn: "0082383142", tanggalLahir: "2008-06-01"},
            {no: 15, nama: "Herman Gabriel Fonataba", jk: "Laki-Laki", agama: "Kristen", nisn: "0076202678", tanggalLahir: "2007-08-12"},
            {no: 16, nama: "Jessie Melissa Cantika Latue", jk: "Perempuan", agama: "Kristen", nisn: "0087163665", tanggalLahir: "2008-08-25"},
            {no: 17, nama: "JUEN FRIDA LEKAHENA", jk: "Perempuan", agama: "Kristen", nisn: "0089030733", tanggalLahir: "2008-07-24"},
            {no: 18, nama: "JUNIOR PASKAL TAHITU", jk: "Laki-Laki", agama: "Kristen", nisn: "3081721982", tanggalLahir: "2008-06-06"},
            {no: 19, nama: "KIKI KHUSNUL OKTAVIANTI", jk: "Perempuan", agama: "Islam", nisn: "0084883601", tanggalLahir: "2008-10-18"},
            {no: 20, nama: "MARIA FRESENDA LEWATAKA", jk: "Perempuan", agama: "Kristen", nisn: "0075144653", tanggalLahir: "2007-02-23"},
            {no: 21, nama: "MARIA MAGDALENA SNANFI", jk: "Perempuan", agama: "Kristen", nisn: "0068245373", tanggalLahir: "2006-12-26"},
            {no: 22, nama: "Maya Rosaida Paa", jk: "Perempuan", agama: "Islam", nisn: "0083549719", tanggalLahir: "2008-03-02"},
            {no: 23, nama: "MELANI STEFANNY LOIWATU", jk: "Perempuan", agama: "Kristen", nisn: "0083620504", tanggalLahir: "2008-09-22"},
            {no: 24, nama: "MUHAMMAD FADLAN", jk: "Laki-Laki", agama: "Islam", nisn: "0088975994", tanggalLahir: "2008-07-15"},
            {no: 25, nama: "NAOMI TRESIA PAITEI", jk: "Perempuan", agama: "Kristen", nisn: "0069826001", tanggalLahir: "2006-09-17"},
            {no: 26, nama: "NATHALIA RUMBINO", jk: "Perempuan", agama: "Kristen", nisn: "0084346261", tanggalLahir: "2008-12-24"},
            {no: 27, nama: "Novela Jessica Ta'bilangi", jk: "Perempuan", agama: "Kristen", nisn: "0084620689", tanggalLahir: "2008-11-09"},
            {no: 28, nama: "OLGA I. LIKLIKWATIL", jk: "Perempuan", agama: "Kristen", nisn: "0083566510", tanggalLahir: "2008-06-29"},
            {no: 29, nama: "RACHEL MANUELA MAYOR", jk: "Perempuan", agama: "Kristen", nisn: "0074609402", tanggalLahir: "2007-10-25"},
            {no: 30, nama: "RATNA SARI ABDULMUIN", jk: "Perempuan", agama: "Islam", nisn: "0073546378", tanggalLahir: "2007-03-18"},
            {no: 31, nama: "Raymond Edwin Soselisa", jk: "Laki-Laki", agama: "Kristen", nisn: "0075153529", tanggalLahir: "2007-10-31"},
            {no: 32, nama: "Rizky", jk: "Laki-Laki", agama: "Islam", nisn: "0072596236", tanggalLahir: "2007-12-20"},
            {no: 33, nama: "SAMUEL.FANIK.TEHUPEIORY", jk: "Laki-Laki", agama: "Kristen", nisn: "0075251376", tanggalLahir: "2007-07-15"},
            {no: 34, nama: "Tiara Arung Silambi", jk: "Perempuan", agama: "Kristen", nisn: "0098566104", tanggalLahir: "2009-04-08"},
            {no: 35, nama: "WULAN RAHMADANI", jk: "Perempuan", agama: "Islam", nisn: "0083616763", tanggalLahir: "2008-08-30"},
            {no: 36, nama: "ZAINU", jk: "Laki-Laki", agama: "Islam", nisn: "0072673338", tanggalLahir: "2007-11-23"}
        ];

        // Google Apps Script Web App URL - Updated with NISN formatting fix
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyM65r6W5gT6zyUIUxqydghoLFsiWgv3Bye_8XrTrqSbTzj_naE-kx8uh3csyB5KB6VfA/exec';
        
        // Google Sheets CSV URL for reading data
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTNnSgqbkECu4Au-f8Tdu6BmN1nsLLAfTdbhoXZ9sEzn-1jtqpW0iL2jxrHlY1DU0VYgc8k0sZq0-19/pub?gid=1335189182&single=true&output=csv';

        // Calculate age from birth date
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        // Initialize the application
        function init() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            populateStudentsTable();
            setDefaultDate();
        }

        // Set default date to today
        function setDefaultDate() {
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('tanggal-absensi').value = formattedDate;
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            };
            
            document.getElementById('current-date').textContent = now.toLocaleDateString('id-ID', dateOptions);
            document.getElementById('current-time').textContent = now.toLocaleTimeString('id-ID', timeOptions);
        }

        // Populate students cards
        function populateStudentsTable() {
            const container = document.getElementById('students-container');
            container.innerHTML = '';

            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'bg-gradient-to-br from-white to-gray-50 rounded-xl border border-gray-200 p-3 sm:p-4 lg:p-5 hover:shadow-lg transition-all duration-300 hover:scale-105';
                
                // Get gender icon and color
                const genderIcon = student.jk === 'Laki-Laki' ? 'fas fa-mars text-blue-500' : 'fas fa-venus text-pink-500';
                const religionIcon = student.agama === 'Islam' ? '‚ò™Ô∏è' : student.agama === 'Kristen' ? '‚úùÔ∏è' : 'üïâÔ∏è';
                
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-3 sm:mb-4">
                        <div class="flex items-center space-x-2 sm:space-x-3 flex-1">
                            <div class="w-8 h-8 sm:w-10 sm:h-10 lg:w-12 lg:h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xs sm:text-sm lg:text-lg">
                                ${student.no}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-gray-800 text-xs sm:text-sm leading-tight truncate">${student.nama}</h4>
                                <div class="flex items-center space-x-1 sm:space-x-2 mt-1">
                                    <i class="${genderIcon} text-xs sm:text-sm"></i>
                                    <span class="text-xs text-gray-600">${student.jk}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-1 sm:space-y-2 mb-3 sm:mb-4">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-500">NISN:</span>
                            <span class="font-medium text-gray-700 text-xs">${student.nisn}</span>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-500">Agama:</span>
                            <span class="font-medium text-gray-700 text-xs">${religionIcon} ${student.agama}</span>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-500">Lahir:</span>
                            <span class="font-medium text-gray-700 text-xs">${new Date(student.tanggalLahir).toLocaleDateString('id-ID')}</span>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-500">Umur:</span>
                            <span class="font-medium text-gray-700 text-xs">${calculateAge(student.tanggalLahir)} tahun</span>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-3 sm:pt-4">
                        <p class="text-xs font-medium text-gray-600 mb-2 sm:mb-3">Status Kehadiran:</p>
                        <div class="grid grid-cols-2 gap-1 sm:gap-2 mb-2 sm:mb-3">
                            <button onclick="setStatus(${student.no}, 'Hadir')" class="px-2 sm:px-3 py-1 sm:py-2 text-xs font-medium rounded-lg bg-green-100 text-green-800 hover:bg-green-200 transition-colors flex items-center justify-center">
                                <i class="fas fa-check mr-1"></i><span class="hidden sm:inline">Hadir</span><span class="sm:hidden">‚úì</span>
                            </button>
                            <button onclick="setStatus(${student.no}, 'Sakit')" class="px-2 sm:px-3 py-1 sm:py-2 text-xs font-medium rounded-lg bg-yellow-100 text-yellow-800 hover:bg-yellow-200 transition-colors flex items-center justify-center">
                                <i class="fas fa-thermometer-half mr-1"></i><span class="hidden sm:inline">Sakit</span><span class="sm:hidden">ü§í</span>
                            </button>
                            <button onclick="setStatus(${student.no}, 'Izin')" class="px-2 sm:px-3 py-1 sm:py-2 text-xs font-medium rounded-lg bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors flex items-center justify-center">
                                <i class="fas fa-hand-paper mr-1"></i><span class="hidden sm:inline">Izin</span><span class="sm:hidden">‚úã</span>
                            </button>
                            <button onclick="setStatus(${student.no}, 'Alpa')" class="px-2 sm:px-3 py-1 sm:py-2 text-xs font-medium rounded-lg bg-red-100 text-red-800 hover:bg-red-200 transition-colors flex items-center justify-center">
                                <i class="fas fa-times mr-1"></i><span class="hidden sm:inline">Alpa</span><span class="sm:hidden">‚úó</span>
                            </button>
                        </div>
                        <button onclick="setStatus(${student.no}, 'Bolos')" class="w-full px-2 sm:px-3 py-1 sm:py-2 text-xs font-medium rounded-lg bg-purple-100 text-purple-800 hover:bg-purple-200 transition-colors flex items-center justify-center">
                            <i class="fas fa-user-slash mr-1"></i><span class="hidden sm:inline">Bolos</span><span class="sm:hidden">üö´</span>
                        </button>
                        
                        <div class="mt-2 sm:mt-3 text-center">
                            <span id="status-${student.no}" class="inline-flex items-center px-2 sm:px-3 py-1 sm:py-2 rounded-lg text-xs sm:text-sm font-medium bg-gray-100 text-gray-800 border-2 border-dashed border-gray-300">
                                <i class="fas fa-clock mr-1 sm:mr-2"></i>Belum Dipilih
                            </span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Set individual student status
        function setStatus(studentNo, status) {
            const statusElement = document.getElementById(`status-${studentNo}`);
            
            // Update styling and content based on status
            statusElement.className = 'inline-flex items-center px-3 py-2 rounded-lg text-sm font-medium border-2 ';
            let icon = '';
            
            switch(status) {
                case 'Hadir':
                    statusElement.className += 'bg-green-100 text-green-800 border-green-300';
                    icon = 'fas fa-check-circle';
                    break;
                case 'Sakit':
                    statusElement.className += 'bg-yellow-100 text-yellow-800 border-yellow-300';
                    icon = 'fas fa-thermometer-half';
                    break;
                case 'Izin':
                    statusElement.className += 'bg-blue-100 text-blue-800 border-blue-300';
                    icon = 'fas fa-hand-paper';
                    break;
                case 'Alpa':
                    statusElement.className += 'bg-red-100 text-red-800 border-red-300';
                    icon = 'fas fa-times-circle';
                    break;
                case 'Bolos':
                    statusElement.className += 'bg-purple-100 text-purple-800 border-purple-300';
                    icon = 'fas fa-user-slash';
                    break;
            }
            
            statusElement.innerHTML = `<i class="${icon} mr-2"></i>${status}`;
        }

        // Set all students to a specific status
        function setAllStatus(status) {
            students.forEach(student => {
                setStatus(student.no, status);
            });
        }

        // Check if attendance data already exists
        async function checkDuplicateAttendance(tanggal, jamKe) {
            try {
                console.log('Checking for duplicate attendance...');
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                
                // Parse CSV data
                const lines = csvText.split('\n');
                
                if (lines.length <= 1) {
                    console.log('No existing data found');
                    return false; // No data exists
                }
                
                const selectedDate = new Date(tanggal);
                const formattedDate = selectedDate.toLocaleDateString('id-ID');
                
                console.log(`Looking for: Date=${formattedDate}, Jam=${jamKe}`);
                
                // Check each row for matching date and jam (skip header row)
                let duplicateCount = 0;
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === '') continue; // Skip empty lines
                    
                    const columns = line.split(',');
                    if (columns.length >= 2) {
                        const existingDate = columns[0].trim().replace(/"/g, '');
                        const existingJam = columns[1].trim().replace(/"/g, '');
                        
                        console.log(`Row ${i}: Date=${existingDate}, Jam=${existingJam}`);
                        
                        if (existingDate === formattedDate && existingJam === jamKe) {
                            duplicateCount++;
                            console.log(`Duplicate found! Count: ${duplicateCount}`);
                        }
                    }
                }
                
                // If we find 36 records (full class), it means data already exists
                const isDuplicate = duplicateCount >= 36;
                console.log(`Total matching records: ${duplicateCount}, Is duplicate: ${isDuplicate}`);
                
                return isDuplicate;
            } catch (error) {
                console.error('Error checking duplicate:', error);
                // Show warning but allow submission
                alert('Peringatan: Tidak dapat memeriksa data duplikat. Pastikan data belum pernah dikirim sebelumnya.');
                return false;
            }
        }

        // Submit attendance data
        async function submitAbsensi() {
            const jamKe = document.getElementById('jam-ke').value;
            const tanggalAbsensi = document.getElementById('tanggal-absensi').value;
            
            if (!jamKe) {
                alert('Mohon pilih Jam Pelajaran terlebih dahulu!');
                return;
            }
            
            if (!tanggalAbsensi) {
                alert('Mohon pilih Tanggal Absensi terlebih dahulu!');
                return;
            }

            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Memeriksa data...';
            submitBtn.disabled = true;

            // Check for duplicate data
            const isDuplicate = await checkDuplicateAttendance(tanggalAbsensi, jamKe);
            
            if (isDuplicate) {
                const selectedDate = new Date(tanggalAbsensi);
                const formattedDate = selectedDate.toLocaleDateString('id-ID');
                const jamText = jamKe === 'Bimbel' ? 'Bimbel' : `Jam ke-${jamKe}`;
                
                showErrorModal(`‚ö†Ô∏è DATA SUDAH ADA!\n\nAbsensi untuk tanggal ${formattedDate} pada ${jamText} sudah pernah dikirim sebelumnya.\n\n‚ùå Tidak dapat mengirim data yang sama dua kali.\n\n‚úÖ Silakan pilih tanggal atau jam pelajaran yang berbeda.`);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                return;
            }

            submitBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Mengirim...';

            const attendanceData = [];
            const now = new Date();
            const selectedDate = new Date(tanggalAbsensi);
            const formattedDate = selectedDate.toLocaleDateString('id-ID');
            const currentTime = now.toLocaleTimeString('id-ID');

            students.forEach(student => {
                const statusElement = document.getElementById(`status-${student.no}`);
                const status = statusElement.textContent === 'Belum Dipilih' ? 'Alpa' : statusElement.textContent;
                
                attendanceData.push({
                    tanggal: formattedDate,
                    jamKe: jamKe,
                    namaLengkap: student.nama,
                    jenisKelamin: student.jk,
                    nisn: student.nisn,
                    keterangan: status,
                    timestamp: currentTime
                });
            });

            try {
                console.log('Sending data to:', SCRIPT_URL);
                console.log('Data:', attendanceData);
                
                // First try with CORS to get proper response
                let response;
                try {
                    response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(attendanceData)
                    });
                    
                    if (response.ok) {
                        const result = await response.text();
                        console.log('Response:', result);
                        showSuccessModal();
                        updateRekap();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (corsError) {
                    console.log('CORS failed, trying no-cors mode:', corsError);
                    
                    // Fallback to no-cors mode
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(attendanceData)
                    });
                    
                    // Wait a moment then verify data was received
                    setTimeout(async () => {
                        try {
                            // Try to verify by checking if new data appears in the sheet
                            const verifyResponse = await fetch(CSV_URL);
                            const csvText = await verifyResponse.text();
                            
                            // Simple check - if we can fetch the sheet, assume success
                            showSuccessModal();
                            updateRekap();
                        } catch (verifyError) {
                            console.log('Verification failed, but data likely sent:', verifyError);
                            showSuccessModal(); // Still show success as data was sent
                            updateRekap();
                        }
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Error:', error);
                showErrorModal('Terjadi kesalahan saat mengirim data: ' + error.message + '\n\nPastikan koneksi internet stabil dan Google Apps Script sudah di-deploy dengan benar.');
            } finally {
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 3000); // Give more time for the process
            }
        }

        // Show success modal
        function showSuccessModal() {
            document.getElementById('success-modal').classList.remove('hidden');
            document.getElementById('success-modal').classList.add('flex');
        }

        // Show error modal
        function showErrorModal(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
        }

        // Close success modal
        function closeModal() {
            document.getElementById('success-modal').classList.add('hidden');
            document.getElementById('success-modal').classList.remove('flex');
        }

        // Close error modal
        function closeErrorModal() {
            document.getElementById('error-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.remove('flex');
        }

        // Show absensi section
        function showAbsensi() {
            document.getElementById('absensi-section').classList.remove('hidden');
            document.getElementById('rekap-section').classList.add('hidden');
            document.getElementById('edit-section').classList.add('hidden');
            document.getElementById('bimbel-section').classList.add('hidden');
            document.getElementById('btn-absensi').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-blue-500 text-white';
            document.getElementById('btn-rekap').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100';
            document.getElementById('btn-edit').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100';
            document.getElementById('btn-bimbel').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100';
        }

        // Show rekap section
        function showRekap() {
            document.getElementById('absensi-section').classList.add('hidden');
            document.getElementById('rekap-section').classList.remove('hidden');
            document.getElementById('edit-section').classList.add('hidden');
            document.getElementById('bimbel-section').classList.add('hidden');
            document.getElementById('btn-rekap').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-blue-500 text-white';
            document.getElementById('btn-absensi').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100';
            document.getElementById('btn-edit').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100';
            document.getElementById('btn-bimbel').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100';
            setDefaultRekapDate();
            loadRekapData();
        }

        // Set default date for rekap to today
        function setDefaultRekapDate() {
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('rekap-tanggal').value = formattedDate;
        }

        // Filter rekap data based on selected date and period
        function filterRekapData() {
            const selectedDate = document.getElementById('rekap-tanggal').value;
            const selectedPeriod = document.getElementById('rekap-jam-ke').value;
            
            if (!selectedDate) {
                alert('Mohon pilih tanggal terlebih dahulu!');
                return;
            }
            
            loadRekapData(selectedDate, selectedPeriod);
        }

        // Show rekapan semester section
        function showEditAbsen() {
            document.getElementById('absensi-section').classList.add('hidden');
            document.getElementById('rekap-section').classList.add('hidden');
            document.getElementById('edit-section').classList.remove('hidden');
            document.getElementById('bimbel-section').classList.add('hidden');
            document.getElementById('btn-edit').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-blue-500 text-white';
            document.getElementById('btn-absensi').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100';
            document.getElementById('btn-rekap').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100';
            document.getElementById('btn-bimbel').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100';
            setSemesterDate();
            populateSemesterTable();
        }

        // Show bimbel recap section
        function showBimbelRecap() {
            document.getElementById('absensi-section').classList.add('hidden');
            document.getElementById('rekap-section').classList.add('hidden');
            document.getElementById('edit-section').classList.add('hidden');
            document.getElementById('bimbel-section').classList.remove('hidden');
            document.getElementById('btn-bimbel').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-blue-500 text-white';
            document.getElementById('btn-absensi').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100';
            document.getElementById('btn-rekap').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100';
            document.getElementById('btn-edit').className = 'px-6 py-3 rounded-lg font-medium transition-all duration-300 text-gray-600 hover:bg-gray-100';
            setBimbelDate();
            populateBimbelTable();
        }

        // Set semester date display
        function setSemesterDate() {
            const now = new Date();
            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('semester-date').textContent = now.toLocaleDateString('id-ID', dateOptions);
        }

        // Populate semester table with all students and zero counts
        function populateSemesterTable() {
            const tableBody = document.getElementById('semester-table-body');
            tableBody.innerHTML = '';
            
            students.forEach((student, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-100 hover:bg-gray-50';
                
                tr.innerHTML = `
                    <td class="py-4 px-4 text-gray-900 font-medium">${student.no}</td>
                    <td class="py-4 px-4">
                        <div class="font-medium text-gray-900">${student.nama}</div>
                        <div class="text-sm text-gray-500">${student.jk} ‚Ä¢ NISN: ${student.nisn}</div>
                    </td>
                    <td class="py-4 px-3 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-800 font-bold text-sm" id="semester-hadir-${student.no}">
                            0
                        </span>
                    </td>
                    <td class="py-4 px-3 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-800 font-bold text-sm" id="semester-izin-${student.no}">
                            0
                        </span>
                    </td>
                    <td class="py-4 px-3 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-yellow-100 text-yellow-800 font-bold text-sm" id="semester-sakit-${student.no}">
                            0
                        </span>
                    </td>
                    <td class="py-4 px-3 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-800 font-bold text-sm" id="semester-alpa-${student.no}">
                            0
                        </span>
                    </td>
                    <td class="py-4 px-3 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-purple-100 text-purple-800 font-bold text-sm" id="semester-bolos-${student.no}">
                            0
                        </span>
                    </td>
                `;
                
                tableBody.appendChild(tr);
            });
        }

        // Load semester attendance data with daily calculation logic
        async function loadSemesterData() {
            const loadingDiv = document.getElementById('loading-semester');
            const loadBtn = document.getElementById('load-semester-btn');
            
            // Show loading state
            loadingDiv.classList.remove('hidden');
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Loading...';
            
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                
                // Parse CSV data
                const lines = csvText.split('\n');
                
                if (lines.length <= 1) {
                    // No data available - keep existing table with zeros
                    console.log('No attendance data found');
                } else {
                    // Group attendance data by student and date
                    const dailyAttendance = {};
                    
                    // Initialize all students
                    students.forEach(student => {
                        dailyAttendance[student.nama] = {};
                    });
                    
                    // Process data rows (skip header) - Only process Jam 1-9
                    for (let i = 1; i < lines.length; i++) {
                        const columns = lines[i].split(',');
                        if (columns.length >= 6) {
                            const tanggal = columns[0].trim().replace(/"/g, '');
                            const jamKe = columns[1].trim().replace(/"/g, '');
                            const nama = columns[2].trim().replace(/"/g, '');
                            const status = columns[5].trim().replace(/"/g, '').toLowerCase();
                            
                            // Only process if it's Jam 1-9 (exclude Bimbel) and student exists
                            if (jamKe !== 'Bimbel' && dailyAttendance[nama]) {
                                if (!dailyAttendance[nama][tanggal]) {
                                    dailyAttendance[nama][tanggal] = [];
                                }
                                
                                dailyAttendance[nama][tanggal].push({
                                    jam: parseInt(jamKe),
                                    status: status
                                });
                            }
                        }
                    }
                    
                    // Calculate daily status for each student
                    const finalCounts = {};
                    
                    students.forEach(student => {
                        finalCounts[student.nama] = {
                            hadir: 0,
                            izin: 0,
                            sakit: 0,
                            alpa: 0,
                            bolos: 0
                        };
                        
                        const studentDays = dailyAttendance[student.nama];
                        
                        // Process each day for this student
                        Object.keys(studentDays).forEach(date => {
                            const dayRecords = studentDays[date];
                            
                            // Sort by jam (class period)
                            dayRecords.sort((a, b) => a.jam - b.jam);
                            
                            // Apply daily status logic
                            const dailyStatus = calculateDailyStatus(dayRecords);
                            finalCounts[student.nama][dailyStatus]++;
                        });
                    });
                    
                    // Update the existing table with calculated counts
                    students.forEach(student => {
                        const counts = finalCounts[student.nama];
                        
                        // Update each count in the existing table
                        const hadirElement = document.getElementById(`semester-hadir-${student.no}`);
                        const izinElement = document.getElementById(`semester-izin-${student.no}`);
                        const sakitElement = document.getElementById(`semester-sakit-${student.no}`);
                        const alpaElement = document.getElementById(`semester-alpa-${student.no}`);
                        const bolosElement = document.getElementById(`semester-bolos-${student.no}`);
                        
                        if (hadirElement) hadirElement.textContent = counts.hadir;
                        if (izinElement) izinElement.textContent = counts.izin;
                        if (sakitElement) sakitElement.textContent = counts.sakit;
                        if (alpaElement) alpaElement.textContent = counts.alpa;
                        if (bolosElement) bolosElement.textContent = counts.bolos;
                    });
                }
                
            } catch (error) {
                console.error('Error loading semester data:', error);
                // Show error message but keep the table structure
                alert('Gagal memuat data rekapan semester. Silakan coba lagi.');
            } finally {
                // Hide loading state
                loadingDiv.classList.add('hidden');
                loadBtn.disabled = false;
                loadBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Muat Data';
            }
        }

        // Calculate daily status based on class period attendance
        function calculateDailyStatus(dayRecords) {
            // Count each status type
            const statusCounts = {
                hadir: 0,
                sakit: 0,
                izin: 0,
                alpa: 0,
                bolos: 0
            };
            
            dayRecords.forEach(record => {
                statusCounts[record.status]++;
            });
            
            // Priority logic for daily status:
            
            // 1. If any "bolos" in the day -> BOLOS (unless they attended later)
            if (statusCounts.bolos > 0) {
                // Check if they attended any class after bolos
                let hasBolos = false;
                let attendedAfterBolos = false;
                
                for (let i = 0; i < dayRecords.length; i++) {
                    if (dayRecords[i].status === 'bolos') {
                        hasBolos = true;
                    } else if (hasBolos && dayRecords[i].status === 'hadir') {
                        attendedAfterBolos = true;
                        break;
                    }
                }
                
                // If they didn't attend after bolos, mark as bolos
                if (!attendedAfterBolos) {
                    return 'bolos';
                }
            }
            
            // 2. If any "hadir" in the day -> HADIR (they showed up at some point)
            if (statusCounts.hadir > 0) {
                return 'hadir';
            }
            
            // 3. If all "sakit" -> SAKIT
            if (statusCounts.sakit > 0 && statusCounts.izin === 0 && statusCounts.alpa === 0) {
                return 'sakit';
            }
            
            // 4. If any "izin" and no "hadir" -> IZIN
            if (statusCounts.izin > 0) {
                // Special case: if izin at first/middle periods but hadir at end -> HADIR (already handled above)
                // If izin at last period -> IZIN
                const lastRecord = dayRecords[dayRecords.length - 1];
                if (lastRecord.status === 'izin') {
                    return 'izin';
                }
                
                // If izin in middle but no hadir later -> IZIN
                return 'izin';
            }
            
            // 5. If mixed sakit and other non-hadir -> SAKIT
            if (statusCounts.sakit > 0) {
                return 'sakit';
            }
            
            // 6. Default to ALPA
            return 'alpa';
        }

        // Load and calculate rekap data from spreadsheet
        async function loadRekapData(filterDate = null, filterPeriod = null) {
            // Show loading state for rekap cards
            const countElements = ['count-hadir', 'count-sakit', 'count-izin', 'count-alpa', 'count-bolos'];
            countElements.forEach(id => {
                document.getElementById(id).innerHTML = '<div class="loading-spinner inline-block"></div>';
            });

            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                
                // Parse CSV data
                const lines = csvText.split('\n');
                
                if (lines.length <= 1) {
                    // No data available
                    countElements.forEach(id => {
                        document.getElementById(id).textContent = '0';
                    });
                    updateRekapInfo('Tidak ada data', filterPeriod);
                    return;
                }

                // Determine filter date
                let targetDate;
                if (filterDate) {
                    const selectedDate = new Date(filterDate);
                    targetDate = selectedDate.toLocaleDateString('id-ID');
                } else {
                    const today = new Date();
                    targetDate = today.toLocaleDateString('id-ID');
                }
                
                const counts = {
                    hadir: 0,
                    sakit: 0,
                    izin: 0,
                    alpa: 0,
                    bolos: 0
                };

                // Process data rows (skip header)
                for (let i = 1; i < lines.length; i++) {
                    const columns = lines[i].split(',');
                    if (columns.length >= 6) {
                        const date = columns[0].trim().replace(/"/g, '');
                        const period = columns[1].trim().replace(/"/g, '');
                        const status = columns[5].trim().replace(/"/g, '').toLowerCase();
                        
                        // Apply date filter
                        let dateMatch = date === targetDate;
                        
                        // Apply period filter if specified
                        let periodMatch = true;
                        if (filterPeriod && filterPeriod !== '') {
                            periodMatch = period === filterPeriod;
                        }
                        
                        // Count if both filters match
                        if (dateMatch && periodMatch) {
                            switch(status) {
                                case 'hadir':
                                    counts.hadir++;
                                    break;
                                case 'sakit':
                                    counts.sakit++;
                                    break;
                                case 'izin':
                                    counts.izin++;
                                    break;
                                case 'alpa':
                                    counts.alpa++;
                                    break;
                                case 'bolos':
                                    counts.bolos++;
                                    break;
                            }
                        }
                    }
                }

                // Update the display
                document.getElementById('count-hadir').textContent = counts.hadir;
                document.getElementById('count-sakit').textContent = counts.sakit;
                document.getElementById('count-izin').textContent = counts.izin;
                document.getElementById('count-alpa').textContent = counts.alpa;
                document.getElementById('count-bolos').textContent = counts.bolos;

                // Update info text
                updateRekapInfo(targetDate, filterPeriod);

            } catch (error) {
                console.error('Error loading rekap data:', error);
                // Show error state
                countElements.forEach(id => {
                    document.getElementById(id).textContent = '?';
                });
                updateRekapInfo('Error loading data', filterPeriod);
            }
        }

        // Update rekap info text
        function updateRekapInfo(date, period) {
            const infoElement = document.getElementById('rekap-info');
            let infoText = `Data tanggal: ${date}`;
            
            if (period && period !== '') {
                const periodText = period === 'Bimbel' ? 'Bimbel' : `Jam ke-${period}`;
                infoText += ` - ${periodText}`;
            } else {
                infoText += ' - Semua jam pelajaran';
            }
            
            infoElement.textContent = infoText;
        }

        // Update rekap counts (for local data only - used after submission)
        function updateRekap() {
            const counts = {
                hadir: 0,
                sakit: 0,
                izin: 0,
                alpa: 0,
                bolos: 0
            };

            students.forEach(student => {
                const statusElement = document.getElementById(`status-${student.no}`);
                const status = statusElement.textContent.toLowerCase();
                
                if (status === 'hadir') counts.hadir++;
                else if (status === 'sakit') counts.sakit++;
                else if (status === 'izin') counts.izin++;
                else if (status === 'alpa') counts.alpa++;
                else if (status === 'bolos') counts.bolos++;
                else counts.alpa++; // Default to alpa if not set
            });

            document.getElementById('count-hadir').textContent = counts.hadir;
            document.getElementById('count-sakit').textContent = counts.sakit;
            document.getElementById('count-izin').textContent = counts.izin;
            document.getElementById('count-alpa').textContent = counts.alpa;
            document.getElementById('count-bolos').textContent = counts.bolos;
        }

        // Load attendance history from Google Sheets
        async function loadAttendanceHistory() {
            const loadingDiv = document.getElementById('loading-history');
            const tableBody = document.getElementById('history-table-body');
            const refreshBtn = document.getElementById('refresh-btn');
            
            // Show loading state
            loadingDiv.classList.remove('hidden');
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Loading...';
            
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                
                // Parse CSV data
                const lines = csvText.split('\n');
                
                // Clear existing table data
                tableBody.innerHTML = '';
                
                if (lines.length <= 1) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-8 text-gray-500">
                                Belum ada data absensi
                            </td>
                        </tr>
                    `;
                } else {
                    // Process data rows (skip header) and reverse to show newest first
                    const dataRows = lines.slice(1).reverse();
                    
                    // Parse data into objects for sorting
                    const attendanceRecords = [];
                    dataRows.forEach(line => {
                        const columns = line.split(',');
                        if (columns.length >= 7) {
                            attendanceRecords.push({
                                tanggal: columns[0].trim().replace(/"/g, ''),
                                jamKe: columns[1].trim().replace(/"/g, ''),
                                nama: columns[2].trim().replace(/"/g, ''),
                                jk: columns[3].trim().replace(/"/g, ''),
                                nisn: columns[4].trim().replace(/"/g, ''),
                                status: columns[5].trim().replace(/"/g, ''),
                                waktu: columns[6].trim().replace(/"/g, '')
                            });
                        }
                    });
                    
                    // Sort by name alphabetically (A-Z)
                    attendanceRecords.sort((a, b) => a.nama.localeCompare(b.nama, 'id', { sensitivity: 'base' }));
                    
                    // Create table rows from sorted data
                    attendanceRecords.forEach(record => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-gray-100 hover:bg-gray-50';
                        
                        // Get status color
                        let statusClass = 'bg-gray-100 text-gray-800';
                        
                        switch(record.status.toLowerCase()) {
                            case 'hadir':
                                statusClass = 'bg-green-100 text-green-800';
                                break;
                            case 'sakit':
                                statusClass = 'bg-yellow-100 text-yellow-800';
                                break;
                            case 'izin':
                                statusClass = 'bg-blue-100 text-blue-800';
                                break;
                            case 'alpa':
                            case 'bolos':
                                statusClass = 'bg-red-100 text-red-800';
                                break;
                        }
                        
                        tr.innerHTML = `
                            <td class="py-3 px-2 text-gray-900">${record.tanggal}</td>
                            <td class="py-3 px-2 text-gray-900">${record.jamKe}</td>
                            <td class="py-3 px-2">
                                <div class="font-medium text-gray-900">${record.nama}</div>
                            </td>
                            <td class="py-3 px-2 text-gray-700">${record.jk}</td>
                            <td class="py-3 px-2 text-gray-700">${record.nisn}</td>
                            <td class="py-3 px-2">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                    ${record.status}
                                </span>
                            </td>
                            <td class="py-3 px-2 text-gray-700">${record.waktu}</td>
                        `;
                        
                        tableBody.appendChild(tr);
                    });
                }
                
            } catch (error) {
                console.error('Error loading attendance history:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-red-500">
                            Gagal memuat data riwayat absensi. Silakan coba lagi.
                        </td>
                    </tr>
                `;
            } finally {
                // Hide loading state
                loadingDiv.classList.add('hidden');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Refresh Data';
            }
        }

        // Set bimbel date display
        function setBimbelDate() {
            const now = new Date();
            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('bimbel-date').textContent = now.toLocaleDateString('id-ID', dateOptions);
        }

        // Populate bimbel table with all students and zero counts
        function populateBimbelTable() {
            const tableBody = document.getElementById('bimbel-table-body');
            tableBody.innerHTML = '';
            
            students.forEach((student, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-100 hover:bg-gray-50';
                
                tr.innerHTML = `
                    <td class="py-4 px-4 text-gray-900 font-medium">${student.no}</td>
                    <td class="py-4 px-4">
                        <div class="font-medium text-gray-900">${student.nama}</div>
                        <div class="text-sm text-gray-500">${student.jk} ‚Ä¢ NISN: ${student.nisn}</div>
                    </td>
                    <td class="py-4 px-3 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-800 font-bold text-sm" id="bimbel-hadir-${student.no}">
                            0
                        </span>
                    </td>
                    <td class="py-4 px-3 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-800 font-bold text-sm" id="bimbel-izin-${student.no}">
                            0
                        </span>
                    </td>
                    <td class="py-4 px-3 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-yellow-100 text-yellow-800 font-bold text-sm" id="bimbel-sakit-${student.no}">
                            0
                        </span>
                    </td>
                    <td class="py-4 px-3 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-800 font-bold text-sm" id="bimbel-alpa-${student.no}">
                            0
                        </span>
                    </td>
                    <td class="py-4 px-3 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-purple-100 text-purple-800 font-bold text-sm" id="bimbel-bolos-${student.no}">
                            0
                        </span>
                    </td>
                `;
                
                tableBody.appendChild(tr);
            });
        }

        // Load bimbel attendance data - ONLY for Bimbel sessions
        async function loadBimbelData() {
            const loadingDiv = document.getElementById('loading-bimbel');
            const loadBtn = document.getElementById('load-bimbel-btn');
            
            // Show loading state
            loadingDiv.classList.remove('hidden');
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Loading...';
            
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                
                // Parse CSV data
                const lines = csvText.split('\n');
                
                if (lines.length <= 1) {
                    // No data available - keep existing table with zeros
                    console.log('No bimbel attendance data found');
                } else {
                    // Initialize attendance counts for each student
                    const attendanceCounts = {};
                    
                    // Initialize all students with zero counts
                    students.forEach(student => {
                        attendanceCounts[student.nama] = {
                            hadir: 0,
                            izin: 0,
                            sakit: 0,
                            alpa: 0,
                            bolos: 0
                        };
                    });
                    
                    // Process data rows (skip header) - ONLY count records where jamKe = "Bimbel"
                    for (let i = 1; i < lines.length; i++) {
                        const columns = lines[i].split(',');
                        if (columns.length >= 6) {
                            const jamKe = columns[1].trim().replace(/"/g, '');
                            const nama = columns[2].trim().replace(/"/g, '');
                            const status = columns[5].trim().replace(/"/g, '').toLowerCase();
                            
                            // STRICT FILTER: Only count if jamKe is exactly "Bimbel"
                            if (jamKe === 'Bimbel' && attendanceCounts[nama]) {
                                console.log(`Processing Bimbel record: ${nama} - ${status}`);
                                
                                switch(status) {
                                    case 'hadir':
                                        attendanceCounts[nama].hadir++;
                                        break;
                                    case 'izin':
                                        attendanceCounts[nama].izin++;
                                        break;
                                    case 'sakit':
                                        attendanceCounts[nama].sakit++;
                                        break;
                                    case 'alpa':
                                        attendanceCounts[nama].alpa++;
                                        break;
                                    case 'bolos':
                                        attendanceCounts[nama].bolos++;
                                        break;
                                }
                            }
                        }
                    }
                    
                    // Update the existing table with actual counts
                    students.forEach(student => {
                        const counts = attendanceCounts[student.nama];
                        
                        // Update each count in the existing table
                        const hadirElement = document.getElementById(`bimbel-hadir-${student.no}`);
                        const izinElement = document.getElementById(`bimbel-izin-${student.no}`);
                        const sakitElement = document.getElementById(`bimbel-sakit-${student.no}`);
                        const alpaElement = document.getElementById(`bimbel-alpa-${student.no}`);
                        const bolosElement = document.getElementById(`bimbel-bolos-${student.no}`);
                        
                        if (hadirElement) hadirElement.textContent = counts.hadir;
                        if (izinElement) izinElement.textContent = counts.izin;
                        if (sakitElement) sakitElement.textContent = counts.sakit;
                        if (alpaElement) alpaElement.textContent = counts.alpa;
                        if (bolosElement) bolosElement.textContent = counts.bolos;
                    });
                    
                    console.log('Bimbel data loaded successfully');
                }
                
            } catch (error) {
                console.error('Error loading bimbel data:', error);
                // Show error message but keep the table structure
                alert('Gagal memuat data rekapan bimbel. Silakan coba lagi.');
            } finally {
                // Hide loading state
                loadingDiv.classList.add('hidden');
                loadBtn.disabled = false;
                loadBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Muat Data Bimbel';
            }
        }

        // Load detailed attendance for selected date and period
        async function loadDetailedAttendance() {
            const selectedDate = document.getElementById('rekap-tanggal').value;
            const selectedPeriod = document.getElementById('rekap-jam-ke').value;
            
            if (!selectedDate) {
                alert('Mohon pilih tanggal terlebih dahulu!');
                return;
            }
            
            const loadingDiv = document.getElementById('loading-detailed');
            const contentDiv = document.getElementById('detailed-attendance-content');
            const loadBtn = document.getElementById('load-detail-btn');
            
            // Show loading state
            loadingDiv.classList.remove('hidden');
            contentDiv.classList.add('hidden');
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Loading...';
            
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                
                // Parse CSV data
                const lines = csvText.split('\n');
                
                if (lines.length <= 1) {
                    contentDiv.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4 text-gray-300"></i>
                            <p>Belum ada data absensi untuk tanggal yang dipilih</p>
                        </div>
                    `;
                    contentDiv.classList.remove('hidden');
                    return;
                }

                // Determine filter date
                const targetDate = new Date(selectedDate).toLocaleDateString('id-ID');
                
                // Collect attendance data for the selected date
                const attendanceByPeriod = {};
                
                // Process data rows (skip header)
                for (let i = 1; i < lines.length; i++) {
                    const columns = lines[i].split(',');
                    if (columns.length >= 6) {
                        const date = columns[0].trim().replace(/"/g, '');
                        const period = columns[1].trim().replace(/"/g, '');
                        const nama = columns[2].trim().replace(/"/g, '');
                        const jk = columns[3].trim().replace(/"/g, '');
                        const nisn = columns[4].trim().replace(/"/g, '');
                        const status = columns[5].trim().replace(/"/g, '');
                        
                        // Only include data for the selected date
                        if (date === targetDate) {
                            // Apply period filter if specified
                            if (!selectedPeriod || selectedPeriod === '' || period === selectedPeriod) {
                                if (!attendanceByPeriod[period]) {
                                    attendanceByPeriod[period] = [];
                                }
                                
                                attendanceByPeriod[period].push({
                                    nama: nama,
                                    jk: jk,
                                    nisn: nisn,
                                    status: status
                                });
                            }
                        }
                    }
                }
                
                // Generate HTML content
                let htmlContent = '';
                
                if (Object.keys(attendanceByPeriod).length === 0) {
                    htmlContent = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-calendar-times text-4xl mb-4 text-gray-300"></i>
                            <p>Tidak ada data absensi untuk filter yang dipilih</p>
                            <p class="text-sm mt-2">Tanggal: ${targetDate}${selectedPeriod ? ` - ${selectedPeriod === 'Bimbel' ? 'Bimbel' : 'Jam ke-' + selectedPeriod}` : ''}</p>
                        </div>
                    `;
                } else {
                    // Sort periods (1-9, then Bimbel)
                    const sortedPeriods = Object.keys(attendanceByPeriod).sort((a, b) => {
                        if (a === 'Bimbel') return 1;
                        if (b === 'Bimbel') return -1;
                        return parseInt(a) - parseInt(b);
                    });
                    
                    htmlContent = `
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-2">
                                <i class="fas fa-info-circle mr-2"></i>Detail Kehadiran
                            </h4>
                            <p class="text-blue-700">
                                Tanggal: <span class="font-medium">${targetDate}</span>
                                ${selectedPeriod ? ` - ${selectedPeriod === 'Bimbel' ? 'Bimbel' : 'Jam ke-' + selectedPeriod}` : ' - Semua Jam Pelajaran'}
                            </p>
                        </div>
                    `;
                    
                    sortedPeriods.forEach(period => {
                        const students = attendanceByPeriod[period];
                        const periodTitle = period === 'Bimbel' ? 'Bimbel' : `Jam ke-${period}`;
                        
                        // Sort students alphabetically
                        students.sort((a, b) => a.nama.localeCompare(b.nama, 'id', { sensitivity: 'base' }));
                        
                        // Count status
                        const statusCounts = {
                            hadir: students.filter(s => s.status.toLowerCase() === 'hadir').length,
                            sakit: students.filter(s => s.status.toLowerCase() === 'sakit').length,
                            izin: students.filter(s => s.status.toLowerCase() === 'izin').length,
                            alpa: students.filter(s => s.status.toLowerCase() === 'alpa').length,
                            bolos: students.filter(s => s.status.toLowerCase() === 'bolos').length
                        };
                        
                        htmlContent += `
                            <div class="mb-6 border border-gray-200 rounded-lg overflow-hidden">
                                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4">
                                    <div class="flex justify-between items-center">
                                        <h4 class="text-lg font-bold">
                                            <i class="fas fa-clock mr-2"></i>${periodTitle}
                                        </h4>
                                        <div class="text-sm">
                                            Total: ${students.length} siswa
                                        </div>
                                    </div>
                                    
                                    <!-- Status Summary -->
                                    <div class="grid grid-cols-5 gap-2 mt-3">
                                        <div class="bg-white bg-opacity-20 rounded px-2 py-1 text-center">
                                            <div class="text-xs opacity-90">Hadir</div>
                                            <div class="font-bold">${statusCounts.hadir}</div>
                                        </div>
                                        <div class="bg-white bg-opacity-20 rounded px-2 py-1 text-center">
                                            <div class="text-xs opacity-90">Sakit</div>
                                            <div class="font-bold">${statusCounts.sakit}</div>
                                        </div>
                                        <div class="bg-white bg-opacity-20 rounded px-2 py-1 text-center">
                                            <div class="text-xs opacity-90">Izin</div>
                                            <div class="font-bold">${statusCounts.izin}</div>
                                        </div>
                                        <div class="bg-white bg-opacity-20 rounded px-2 py-1 text-center">
                                            <div class="text-xs opacity-90">Alpa</div>
                                            <div class="font-bold">${statusCounts.alpa}</div>
                                        </div>
                                        <div class="bg-white bg-opacity-20 rounded px-2 py-1 text-center">
                                            <div class="text-xs opacity-90">Bolos</div>
                                            <div class="font-bold">${statusCounts.bolos}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        `;
                        
                        students.forEach((student, index) => {
                            // Get status styling
                            let statusClass = 'bg-gray-100 text-gray-800';
                            let statusIcon = 'fas fa-question';
                            
                            switch(student.status.toLowerCase()) {
                                case 'hadir':
                                    statusClass = 'bg-green-100 text-green-800 border-green-300';
                                    statusIcon = 'fas fa-check-circle';
                                    break;
                                case 'sakit':
                                    statusClass = 'bg-yellow-100 text-yellow-800 border-yellow-300';
                                    statusIcon = 'fas fa-thermometer-half';
                                    break;
                                case 'izin':
                                    statusClass = 'bg-blue-100 text-blue-800 border-blue-300';
                                    statusIcon = 'fas fa-hand-paper';
                                    break;
                                case 'alpa':
                                    statusClass = 'bg-red-100 text-red-800 border-red-300';
                                    statusIcon = 'fas fa-times-circle';
                                    break;
                                case 'bolos':
                                    statusClass = 'bg-purple-100 text-purple-800 border-purple-300';
                                    statusIcon = 'fas fa-user-slash';
                                    break;
                            }
                            
                            // Get student number from the students array
                            const studentData = students.find(s => s.nama === student.nama) || {};
                            const studentNo = students.findIndex(s => s.nama === student.nama) + 1;
                            
                            htmlContent += `
                                <div class="bg-white border border-gray-200 rounded-lg p-3 hover:shadow-md transition-shadow">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xs">
                                                ${index + 1}
                                            </div>
                                            <div class="flex-1">
                                                <h5 class="font-medium text-gray-900 text-sm leading-tight">${student.nama}</h5>
                                                <p class="text-xs text-gray-500">${student.jk} ‚Ä¢ ${student.nisn}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center">
                                        <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium border ${statusClass}">
                                            <i class="${statusIcon} mr-1"></i>${student.status}
                                        </span>
                                    </div>
                                </div>
                            `;
                        });
                        
                        htmlContent += `
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                contentDiv.innerHTML = htmlContent;
                contentDiv.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading detailed attendance:', error);
                contentDiv.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Gagal memuat detail kehadiran siswa</p>
                        <p class="text-sm mt-2">Silakan coba lagi</p>
                    </div>
                `;
                contentDiv.classList.remove('hidden');
            } finally {
                // Hide loading state
                loadingDiv.classList.add('hidden');
                loadBtn.disabled = false;
                loadBtn.innerHTML = '<i class="fas fa-users mr-2"></i>Tampilkan Detail';
            }
        }

        // Copy protection functions
        function disableCopyPaste() {
            // Disable right-click context menu but allow for form elements
            document.addEventListener('contextmenu', function(e) {
                // Allow context menu for form elements
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                    return true;
                }
                e.preventDefault();
                return false;
            });
            
            // Disable text selection but allow for form elements
            document.addEventListener('selectstart', function(e) {
                // Allow selection for form elements
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'OPTION') {
                    return true;
                }
                e.preventDefault();
                return false;
            });
            
            // Disable drag and drop but allow form interactions
            document.addEventListener('dragstart', function(e) {
                // Allow drag for form elements if needed
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                    return true;
                }
                e.preventDefault();
                return false;
            });
            
            // Disable keyboard shortcuts for copy/paste/select all
            document.addEventListener('keydown', function(e) {
                // Disable Ctrl+A (Select All)
                if (e.ctrlKey && e.keyCode === 65) {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+C (Copy)
                if (e.ctrlKey && e.keyCode === 67) {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+V (Paste)
                if (e.ctrlKey && e.keyCode === 86) {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+X (Cut)
                if (e.ctrlKey && e.keyCode === 88) {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+S (Save)
                if (e.ctrlKey && e.keyCode === 83) {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+P (Print)
                if (e.ctrlKey && e.keyCode === 80) {
                    e.preventDefault();
                    return false;
                }
                
                // Disable F12 (Developer Tools)
                if (e.keyCode === 123) {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+Shift+I (Developer Tools)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+Shift+J (Console)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 74) {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+U (View Source)
                if (e.ctrlKey && e.keyCode === 85) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // Disable mouse selection but allow dropdowns
            document.onselectstart = function(e) {
                // Allow selection for input and select elements
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                    return true;
                }
                return false;
            };
            
            document.onmousedown = function(e) {
                // Allow mouse events for input and select elements
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'OPTION') {
                    return true;
                }
                return false;
            };
            
            // Clear clipboard periodically
            setInterval(function() {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText('').catch(function() {
                        // Ignore errors
                    });
                }
            }, 1000);
        }
        
        // Initialize protection and app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            disableCopyPaste();
            init();
        });
        
        // Fallback initialization
        init();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97b917a2c1226045',t:'MTc1NzI3ODM3Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
